{% extends "base.html" %}

{% block title %}Aggiungi Esercizi{% endblock %}

{% block content %}
<h1 class="mt-5">Aggiungi Esercizi</h1>
<form id="exerciseForm" method="POST" action="{{ url_for('submit') }}">
    <div id="exercises">
        <!-- Inizialmente avremo un solo esercizio -->
        <div class="exercise-item border p-3 mb-3" data-index="1">
            <!-- Pulsante per rimuovere l'esercizio -->
            <button type="button" class="close remove-exercise" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <!-- Campi del modulo -->
            <div class="form-group">
                <label>Distretto Muscolare</label>
                <select class="form-control district-select" name="exercises[1][district]" required>
                    <option value="">Seleziona un distretto</option>
                    {% for district in districts %}
                    <option value="{{ district }}">{{ district }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Nome Esercizio</label>
                <select class="form-control exercise-select" name="exercises[1][name]" required>
                    <option value="">Seleziona un esercizio</option>
                    {% for exercise in exercises %}
                    <option value="{{ exercise }}">{{ exercise }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Ripetizioni</label>
                <select class="form-control" name="exercises[1][reps]" required>
                    {% for rep in range(1, 31) %}
                    <option value="{{ rep }}">{{ rep }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Peso (kg)</label>
                <select class="form-control" name="exercises[1][weight]" required>
                    {% for weight in weights %}
                    <option value="{{ weight }}">{{ weight }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <!-- Contenitore per allineare i pulsanti -->
    <div class="d-flex justify-content-between mt-3">
        <button type="button" id="addExercise" class="btn btn-success">Aggiungi Esercizio</button>
        <button type="submit" class="btn btn-primary">Salva</button>
    </div>
</form>

<!-- JavaScript per gestire l'aggiunta e rimozione dinamica degli esercizi -->
<script>
    let exerciseIndex = 1;
    const districtToExercises = {{ district_to_exercises | safe }};
    const exercisesToDistrict = {{ exercises_to_district | safe }};
    const weights = {{ weights | safe }};

    document.getElementById('addExercise').addEventListener('click', function() {
        exerciseIndex++;
        const exerciseItem = document.createElement('div');
        exerciseItem.classList.add('exercise-item', 'border', 'p-3', 'mb-3');
        exerciseItem.setAttribute('data-index', exerciseIndex);
        exerciseItem.innerHTML = `
            <button type="button" class="close remove-exercise" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <div class="form-group">
                <label>Distretto Muscolare</label>
                <select class="form-control district-select" name="exercises[${exerciseIndex}][district]" required>
                    <option value="">Seleziona un distretto</option>
                    {% for district in districts %}
                    <option value="{{ district }}">{{ district }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Nome Esercizio</label>
                <select class="form-control exercise-select" name="exercises[${exerciseIndex}][name]" required>
                    <option value="">Seleziona un esercizio</option>
                    {% for exercise in exercises %}
                    <option value="{{ exercise }}">{{ exercise }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Ripetizioni</label>
                <select class="form-control" name="exercises[${exerciseIndex}][reps]" required>
                    {% for rep in range(1, 31) %}
                    <option value="{{ rep }}">{{ rep }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Peso (kg)</label>
                <select class="form-control" name="exercises[${exerciseIndex}][weight]" required>
                    {% for weight in weights %}
                    <option value="{{ weight }}">{{ weight }}</option>
                    {% endfor %}
                </select>
            </div>
        `;
        document.getElementById('exercises').appendChild(exerciseItem);
    });

    // Funzione per aggiornare i campi quando uno viene modificato
    document.addEventListener('change', function(event) {
        if (event.target && event.target.classList.contains('district-select')) {
            const districtSelect = event.target;
            const exerciseSelect = districtSelect.parentElement.nextElementSibling.querySelector('.exercise-select');
            const selectedDistrict = districtSelect.value;
            // Seleziona gli esercizi corrispondenti al distretto selezionato
            const exercises = districtToExercises[selectedDistrict] || [];
            exerciseSelect.innerHTML = '<option value="">Seleziona un esercizio</option>';
            exercises.forEach(function(exercise) {
                const option = document.createElement('option');
                option.value = exercise;
                option.textContent = exercise;
                exerciseSelect.appendChild(option);
            });
        }

        if (event.target && event.target.classList.contains('exercise-select')) {
            const exerciseSelect = event.target;
            const districtSelect = exerciseSelect.parentElement.previousElementSibling.querySelector('.district-select');
            const selectedExercise = exerciseSelect.value;
            const district = exercisesToDistrict[selectedExercise] || '';
            if (district) {
                districtSelect.value = district;
                // Aggiorna la lista degli esercizi in base al distretto
                const exercises = districtToExercises[district] || [];
                exerciseSelect.innerHTML = '<option value="">Seleziona un esercizio</option>';
                exercises.forEach(function(exercise) {
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    exerciseSelect.appendChild(option);
                });
                // Imposta l'esercizio selezionato
                exerciseSelect.value = selectedExercise;
            }
        }
    });

    // Funzione per rimuovere un esercizio
    document.addEventListener('click', function(event) {
        if (event.target && event.target.closest('.remove-exercise')) {
            const exerciseItem = event.target.closest('.exercise-item');
            exerciseItem.remove();
        }
    });
</script>
{% endblock %}
